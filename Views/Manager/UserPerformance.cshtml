@{
    ViewData["Title"] = "User Performance";

    var user = ViewBag.User as TaskManager.Models.User;
    var tasks = ViewBag.Tasks as List<TaskManager.Models.TaskItem>;
    var projects = ViewBag.UserProjects as List<TaskManager.Models.Project>;
    var ratings = ViewBag.ProjectRatings as List<TaskManager.Models.UserProjectRating>;
}

<h2 class="text-secondary mb-3 text-center">
    <i class="bi bi-person-lines-fill me-2"></i> User Performance Report
</h2>

<!-- USER SELECT -->
<form method="get" action="/Manager/UserPerformance" class="mb-4 mt-2">
    <label class="fw-bold">Select User : </label>
    <select name="userId" class="form-select w-25 d-inline">
        <option value="">Select User </option>
        @foreach (var u in ViewBag.AllUsers)
        {
            <option value="@u.Id" selected="@(user != null && u.Id == user.Id)">
                @u.Name
            </option>
        }
    </select>
    <button class="btn btn-secondary ms-2 ">View</button>
</form>

@if (user == null)
{
    <div class="alert alert-warning">Select a user to view report.</div>
    return;
}

<!-- USER DETAILS -->
<div class="card shadow-sm p-3 mb-4">
    <h4>@user.Name</h4>
    <p><strong>Email:</strong> @user.Email</p>
</div>

<!-- PROJECT RATING -->
@if (projects != null && projects.Count > 0)
{
    <form method="post" action="/Manager/RateUserProject" class="mb-4">
        <input type="hidden" name="userId" value="@user.Id" />

        <label class="fw-bold">Project</label>
        <select name="projectId" class="form-select w-25 d-inline" required>
            <option value="">Select Project</option>
            @foreach (var p in projects)
            {
                <option value="@p.Id">@p.Name</option>
            }
        </select>

        <label class="fw-bold ms-3">Rating</label>
        <select name="rating" class="form-select w-25 d-inline" required>
            <option value="">Select</option>
            @for (int i = 1; i <= 5; i++)
            {
                <option value="@i">@i ★</option>
            }
        </select>

        <button class="btn btn-success ms-2">Submit</button>
    </form>
}

<!-- AVERAGE RATINGS -->
@if (ratings != null && ratings.Count > 0)
{
    <h4>Project Ratings</h4>
    <table class="table table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Project</th>
                <th>Average Rating</th>
                <th>Total Ratings</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var g in ratings.GroupBy(r => r.Project?.Name))
            {
                <tr>
                    <td>@g.Key</td>
                    <td class="text-warning fw-bold">
                        @g.Average(x => x.Rating).ToString("0.0") ★
                    </td>
                    <td>@g.Count()</td>
                </tr>
            }
        </tbody>
    </table>

    <h5 class="mt-4">Rating History</h5>
    <ul class="list-group">
        @foreach (var r in ratings)
        {
            <li class="list-group-item">
                <strong>@(r.Project?.Name ?? "Unknown")</strong> —
                @r.Rating ★
                <span class="float-end text-muted">
                    @r.RatedAt.ToLocalTime().ToString("dd MMM yyyy")
                </span>
            </li>
        }
    </ul>
}

<!-- TASK LIST -->
@if (tasks != null && tasks.Count > 0)
{
    <h4 class="mt-4">Tasks</h4>
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Task</th>
                <th>Project</th>
                <th>Status</th>
                <th>Deadline</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var t in tasks)
            {
                <tr>
                    <td>@t.Title</td>
                    <td>@t.Project?.Name</td>
                    <td>@t.Status</td>
                    <td>@t.Deadline?.ToLocalTime().ToString("dd MMM yyyy")</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info">No tasks assigned to this user.</div>
}
</div>